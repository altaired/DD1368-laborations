WITH combined AS(
  SELECT economy.country AS country, encompasses.continent AS continent, COALESCE(economy.GDP, 0) AS GDP
  FROM economy LEFT JOIN encompasses ON economy.country = encompasses.country
  ORDER BY encompasses.continent, GDP DESC
), top20s AS (
    SELECT continent, country, GDP
    FROM (
      SELECT 
        continent, 
        country,
        GDP,
        COUNT(*) OVER (PARTITION BY continent) AS total,
        row_number() OVER 
        (PARTITION BY continent ORDER BY GDP DESC) AS rownumber
        FROM combined
    ) t
    where rownumber <= 0.20 * total
), grouped AS (
    SELECT continent, MIN(GDP) AS GDP
    FROM top20s
    GROUP BY continent
)

SELECT grouped.continent, combined.country, combined.gdp FROM grouped
LEFT JOIN combined 
ON grouped.continent = combined.continent 
AND grouped.GDP = combined.GDP
ORDER BY combined.GDP DESC;

     continent     | country |  gdp
-------------------+---------+--------
 Europe            | S       | 552000
 Asia              | IR      | 411900
 America           | PR      |  93520
 Africa            | EAK     |  45310
 Australia/Oceania | NCA     |   9280
