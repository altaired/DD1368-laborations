\set user 1
\set movie 2
\set rate 4

WITH completed AS(
  SELECT *
  FROM title_episode
  WHERE parent_tconst != :rate

), thismovie AS(
  SELECT *
  FROM user_watch
  WHERE uconst = :user AND tconst = :movie
)

UPDATE user_watch
SET rating = :rate
WHERE (SELECT COUNT(*) FROM thismovie) > 0 AND (SELECT COUNT(*) FROM completed)> 0
